<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call History Editor — Fixed Template</title>
  <style>
    body{font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial;margin:18px;background:#f6f7fb;color:#111}
    h1{font-size:18px;margin:0 0 10px}
    .wrap{display:flex;gap:18px;align-items:flex-start}
    .panel{background:white;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.06);width:340px}
    label{display:block;font-size:13px;margin-top:8px}
    input[type=text]{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e0e6ef}
    button{margin-top:8px;padding:8px 10px;border-radius:8px;border:0;background:#0b76ff;color:white;cursor:pointer}
    button.secondary{background:#666}
    .canvas-wrap{background:white;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.06)}
    canvas{border:1px solid #ddd;max-width:800px;width:100%;height:auto}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h1>Call History Editor (Fixed)</h1>
  <div class="wrap">
    <div class="panel">
      <label>Nhập số điện thoại</label>
      <input id="phoneInput" type="text" placeholder="Số điện thoại (ví dụ +84...)" />

      <label>Nhập thời lượng</label>
      <input id="durationInput" type="text" placeholder="Ví dụ: 2m hoặc 120s" />

      <label><input id="blurToggle" type="checkbox" /> Blur số điện thoại (chỉ để lại 3 số cuối)</label>

      <button id="createBtn">Tạo (thời gian realtime)</button>
      <button id="downloadBtn" class="secondary">Tải về</button>

      <div style="margin-top:10px">
        <div class="small">Thời gian sẽ lấy lúc bạn bấm "Tạo" (HH:MM).<br>
        Nếu bật Blur SĐT: chỉ để rõ 3 số cuối, phần còn lại sẽ mờ.</div>
      </div>
    </div>

    <div class="canvas-wrap">
      <strong>Preview</strong>
      <canvas id="c" width="591" height="1225"></canvas>
    </div>
  </div>

<script>
(function(){
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  let img = new Image();
  img.src = 'background.jpg'; // ảnh nền để riêng
  img.onload = ()=>{ redraw(); };

  function setFont(size, bold=false){
    ctx.font = (bold? "600 ": "") + size + 'px -apple-system, BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial';
    ctx.fillStyle = '#000';
    ctx.textBaseline = 'middle';
  }
  function drawText(text, area, size, align='left', bold=false){
    setFont(size, bold);
    if(align==='center') ctx.textAlign = 'center';
    else if(align==='right') ctx.textAlign = 'right';
    else ctx.textAlign = 'left';
    const x = align==='center' ? area.x + area.w/2 : (align==='right' ? area.x + area.w : area.x);
    ctx.fillText(text, x, area.y + area.h/2);
  }

  function redraw(phoneText, durationText, blur){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);

    // --- Vị trí cố định (đã hiệu chỉnh) ---
    // SĐT: căn giữa toàn chiều ngang, nằm dưới avatar
    const phoneArea = {x:0, y:360, w:591, h:70};
    // Hàng thông tin cuộc gọi: cùng 1 dòng với "Outgoing Call"
    const timeArea = {x:34,  y:646, w:160, h:32};   // canh trái
    const durArea  = {x:420, y:646, w:140, h:32};   // canh phải

    // Vẽ SĐT (blur mờ che, giữ 3 số cuối rõ)
    if(phoneText){
      if(blur){
        // vẽ text lên offscreen để làm mờ
        const off = document.createElement('canvas');
        off.width = phoneArea.w; off.height = phoneArea.h;
        const octx = off.getContext('2d');
        octx.textBaseline = 'middle';
        octx.textAlign = 'center';
        octx.font = '36px -apple-system, BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial';
        octx.fillStyle = '#000';
        octx.fillText(phoneText, phoneArea.w/2, phoneArea.h/2);
        // tạo bản mờ
        const blurC = document.createElement('canvas');
        blurC.width = phoneArea.w; blurC.height = phoneArea.h;
        const bctx = blurC.getContext('2d');
        bctx.filter = 'blur(6px)';
        bctx.drawImage(off,0,0);
        // dán bản mờ lên nền
        ctx.drawImage(blurC, phoneArea.x, phoneArea.y);
        // vẽ lại 3 số cuối rõ
        const last3 = phoneText.slice(-3);
        setFont(36);
        ctx.textAlign = 'right';
        // đo chiều rộng 3 số cuối để đặt sát mép phải trừ padding
        const pad = 20;
        ctx.fillText(last3, phoneArea.x + phoneArea.w - pad, phoneArea.y + phoneArea.h/2);
      } else {
        drawText(phoneText, phoneArea, 36, 'center');
      }
    }

    // Thời gian realtime HH:MM
    const now = new Date();
    const HH = String(now.getHours()).padStart(2,'0');
    const MM = String(now.getMinutes()).padStart(2,'0');
    const timeText = HH+":"+MM;
    drawText(timeText, timeArea, 17, 'left', true);

    // Thời lượng (ví dụ: 3 seconds / 2m 10s)
    if(durationText){
      drawText(durationText, durArea, 17, 'right');
    }
  }

  document.getElementById('createBtn').addEventListener('click', ()=>{
    const phone = document.getElementById('phoneInput').value.trim();
    const dur = document.getElementById('durationInput').value.trim();
    const blur = document.getElementById('blurToggle').checked;
    redraw(phone, dur, blur);
    window._lastGenerated = canvas;
  });

  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const fc = window._lastGenerated || canvas;
    const a = document.createElement('a');
    a.href = fc.toDataURL('image/png');
    a.download = 'call_history_fixed.png';
    a.click();
  });
})();
</script>
</body>
</html>
